<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Search Clone</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #fff; }
        .container { max-width: 600px; margin: 0 auto; }
        .logo { text-align: center; margin-bottom: 20px; }
        .logo img { width: 272px; height: 92px; }
        .search-bar { display: flex; justify-content: center; margin-bottom: 20px; }
        .search-bar input[type="text"] { width: 100%; padding: 10px; border: 1px solid #dfe1e5; border-radius: 24px; outline: none; font-size: 16px; }
        .search-bar input[type="text"]:hover, .search-bar input[type="text"]:focus { box-shadow: 0 1px 6px rgba(32, 33, 36, 0.28); border-color: rgba(223, 225, 229, 0); }
        .buttons { text-align: center; margin-top: 20px; }
        .buttons button { background-color: #f8f9fa; border: 1px solid #f8f9fa; border-radius: 4px; color: #3c4043; font-family: arial, sans-serif; font-size: 14px; margin: 11px 4px; padding: 0 16px; line-height: 27px; height: 36px; min-width: 54px; text-align: center; cursor: pointer; user-select: none; }
        .buttons button:hover { box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1); background-color: #f8f9fa; border: 1px solid #dadce0; color: #202124; }
        #results { margin-top: 40px; }
        .result-item { margin-bottom: 24px; }
        .favicon { width: 16px; height: 16px; margin-right: 8px; vertical-align: middle; }
        .result-source { display: flex; align-items: center; margin-bottom: 4px; }
        .result-title { color: #1a0dab; text-decoration: none; font-size: 20px; display: block; margin-bottom: 3px; }
        .result-title:hover { text-decoration: underline; }
        .result-item .link { color: #006621; font-style: normal; font-size: 14px; }
        .result-item .snippet { color: #545454; font-size: 14px; line-height: 1.57; }
        .loader { text-align: center; padding: 20px; font-size: 16px; color: #777; }
        .result-item strong, .result-item b { font-weight: normal; background-color: #f1ee8e; padding: 1px 2px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <!-- Modified: Image is now loaded through our server proxy -->
            <img src="/proxy/resource?url=https%3A%2F%2Fwww.google.com%2Fimages%2Fbranding%2Fgooglelogo%2F2x%2Fgooglelogo_color_272x92dp.png" alt="Google Logo">
        </div>
        <div class="search-bar">
            <form id="search-form" style="width: 100%;"><input type="text" id="search-input" required></form>
        </div>
        <div class="buttons">
            <button type="submit" form="search-form">Google Search</button>
        </div>
        <div id="results"></div>
        <div id="loader-container"></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const resultsContainer = document.getElementById('results');
            const loaderContainer = document.getElementById('loader-container');

            // --- Configuration removed, API key is now on the server-side ---
            
            let currentQuery = '', startIndex = 1, isLoading = false, hasMoreResults = true;

            searchForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const query = searchInput.value.trim();
                if (query === '' || query === currentQuery) return;
                currentQuery = query;
                startIndex = 1;
                hasMoreResults = true;
                resultsContainer.innerHTML = '';
                await performSearch();
            });

            window.addEventListener('scroll', () => {
                if (isLoading || !hasMoreResults || !currentQuery) return;
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
                    performSearch();
                }
            });

            async function performSearch() {
                if (isLoading || !hasMoreResults) return;
                isLoading = true;
                showLoader();

                // Modified: Request our own server's API endpoint
                const url = `/api/search?q=${encodeURIComponent(currentQuery)}&start=${startIndex}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Server error! status: ${response.status}`);
                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error);
                    
                    if (!data.items || data.items.length === 0) {
                        hasMoreResults = false;
                        if (startIndex === 1) resultsContainer.innerHTML = '<p>No results found.</p>';
                        return;
                    }
                    
                    displayResults(data.items);
                    startIndex += 10;
                } catch (error) {
                    console.error('Error fetching search results:', error);
                    resultsContainer.innerHTML = `<p>Error: ${error.message}. Please check the server console for details.</p>`;
                } finally {
                    isLoading = false;
                    hideLoader();
                }
            }
            
            function highlightTerms(text, query) {
                if (!query) return text;
                const escapeRegex = (str) => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const terms = query.split(/\s+/).filter(term => term.length > 0).map(escapeRegex);
                if (terms.length === 0) return text;
                const regex = new RegExp(`(${terms.join('|')})`, 'gi');
                return text.replace(regex, '<strong>$&</strong>');
            }

            function displayResults(items) {
                if (!items) return;
                items.forEach(item => {
                    const resultItem = document.createElement('div');
                    resultItem.classList.add('result-item');
                    let hostname = item.displayLink;
                    try { hostname = new URL(item.link).hostname; } catch (e) {}
                    
                    // Modified: Favicon is also loaded through our proxy
                    const faviconGoogleUrl = `https://www.google.com/s2/favicons?domain=${hostname}&sz=16`;
                    const faviconUrl = `/proxy/resource?url=${encodeURIComponent(faviconGoogleUrl)}`;

                    const sourceDiv = document.createElement('div');
                    sourceDiv.classList.add('result-source');
                    const faviconImg = document.createElement('img');
                    faviconImg.classList.add('favicon');
                    faviconImg.src = faviconUrl;
                    faviconImg.alt = 'favicon';
                    faviconImg.onerror = function() { this.style.display = 'none'; };
                    const linkSpan = document.createElement('span');
                    linkSpan.classList.add('link');
                    linkSpan.textContent = item.formattedUrl;
                    sourceDiv.appendChild(faviconImg);
                    sourceDiv.appendChild(linkSpan);

                    const titleLink = document.createElement('a');
                    titleLink.classList.add('result-title');
                    titleLink.href = item.link;
                    titleLink.target = '_blank';
                    titleLink.rel = 'noopener';
                    titleLink.innerHTML = highlightTerms(item.title, currentQuery);

                    const snippet = document.createElement('div');
                    snippet.classList.add('snippet');
                    snippet.innerHTML = item.htmlSnippet;

                    resultItem.appendChild(sourceDiv);
                    resultItem.appendChild(titleLink);
                    resultItem.appendChild(snippet);
                    resultsContainer.appendChild(resultItem);
                });
            }

            function showLoader() { loaderContainer.innerHTML = '<div class="loader">Loading more results...</div>'; }
            function hideLoader() { loaderContainer.innerHTML = ''; }
        });
    </script>
</body>
</html>